<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Report</title>
</head>

<body>
    <h1>Hello world!</h1>
    <button onclick="trigger()">Trigger</button>
    <button onclick="getConfigs()">Get Config</button>
    <button onclick="getBaselineConfigs()">Get Baseline Config</button>
    <h4>API call responses</h4>
    <pre class="prettyprint" id="configs"></pre>
    <h4>Realtime status logs</h4>
    <pre class="prettyprint" id="trigger-status"></pre>
</body>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<script type="text/javascript">
    const socket = io('http://localhost:5000', {
        path: '/socket.io',
        transports: ['websocket'],
        rejectUnauthorized: false
    })
    socket.on("connect_error", (err) => {
        console.log(`connect_error due to ${err.message}`);
    });
    socket.on('connect', () => {
        console.log('connected')
    })
    socket.on("disconnect", () => {
        console.log(socket.id); // undefined
    });
    socket.on('status', (data) => {
        setJSONInnerHTML('trigger-status', data);
    })
    const APIKEY = 'DA0524CF-3073-4346-ACDA-F5816650FE8A';
    const trigger = async () => {
        socket.emit('join', JSON.stringify({
            clientId: APIKEY
        }))
        const url = `/api/trigger?apiKey=${APIKEY}`
        const response = await fetch(url);
        const json = await response.json();
        console.log(json);
        setJSONInnerHTML('configs', json, url);
        return json;
    };

    const getConfigs = async () => {
        const url = "/api/config"
        const response = await fetch(url);
        const json = await response.json();
        console.log(json);
        setJSONInnerHTML('configs', json, url);
        return json;
    };

    const getBaselineConfigs = async () => {
        const url = "/api/baseline"
        const response = await fetch(url);
        const json = await response.json();
        console.log(json);
        setJSONInnerHTML('configs', json, url);
        return json;
    };

    const setJSONInnerHTML = (id, json, api = "api") => {
        const prevHTML = document.getElementById(id).innerHTML;
        document.getElementById(id).innerHTML = (`<h2>${api}</h2>` + "<br />" + JSON.stringify(json, null, 4)) + prevHTML;
    };

</script>

</html>